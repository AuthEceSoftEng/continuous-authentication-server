console.log('Keyguard Script: Init...');var allDOMS=document.getElementsByTagName('*');var keydownDOMObserver=Rx.DOM.keydown(allDOMS);var keyupDOMObserver=Rx.DOM.keyup(allDOMS);var sendDataInterval=0;var KEYSTROKE_DATA_LENGTH_LIMIT=20;var KEYSTROKE_DATA_LENGTH_LIMIT_BACKUP=20;var SEND_DATA_EVERY_N_MILLISECONDS=-1;var SEND_DATA_EVERY_N_MILLISECONDS_BACKUP=-1;var keystrokeData=[];var myheaders={'Content-Type':'application/x-www-form-urlencoded'};let tmp=document.getElementById('contAuthServerScriptTag').src.split('/');var cont_auth_server_url=tmp[0]+'//'+tmp[2];var cont_auth_server_get_keystroke_code_limit=cont_auth_server_url+'/collect/'+'get_keystroke_code_collect_limit/'+track_code
var cont_auth_server_collect_url=cont_auth_server_url+'/collect/'+'keystrokes';var cont_auth_server_get_random_sentence=cont_auth_server_url+'/misc/'+'get-random-sentence-safeshop';var RANDOM_SENTENCE_RETAKE_MAXIMUM_LENGTH=40;var currentUser={'username':'','token':''};var loggedInFlag=!1;var insideImpostorModalFlag=!1;getKeystrokeDataCollectIntervalValue();findUsername();window.addEventListener('beforeunload',function(event){if(insideImpostorModalFlag){console.log('Keyguard Script: User tries to escape');sessionStorage.clear()}else{if(keystrokeData.length>0&&loggedInFlag){sendData(force=!0);console.log('Keyguard Script: onBeforeUnload -> Data Sent');event.preventDefault()}}});function keyGuardLoginProcedureStart(aToken){console.log('Keyguard Script: Login Detected');findUsername(aToken)}
function keyGuardLogoutProcedureStart(){console.log('Keyguard Script: Logout Detected');clearTimerSendData();if(keystrokeData.length>0){sendData(force=!0)}
resetLogInStuff();resetKeystrokeData()}
var keystrokeDOWNSubscriber=keydownDOMObserver.subscribe(function(keyEvent){if(keyEvent.keyCode!==91&&keyEvent.keyCode!==92&&keyEvent.keyCode!==18&&keyEvent.keyCode!==17&&keyEvent.keyCode!==93&&keyEvent.keyCode!==9){onKeyDownProcedure(keyEvent)}},function(err){console.log('Error in keydown event: '+err)});var keystrokeUPSubscriber=keyupDOMObserver.subscribe(function(keyEvent){if(keyEvent.keyCode!==91&&keyEvent.keyCode!==92&&keyEvent.keyCode!==18&&keyEvent.keyCode!==17&&keyEvent.keyCode!==93&&keyEvent.keyCode!==9){onKeyUpProcedure(keyEvent)}},function(err){console.log('Error in keyup event: '+err)});function getKeystrokeDataCollectIntervalValue(){Rx.DOM.get({url:cont_auth_server_get_keystroke_code_limit,headers:myheaders}).subscribe(function(data){res=JSON.parse(data.response);if(res.success==!0){SEND_DATA_EVERY_N_MILLISECONDS=1000*Number(res.keystroke_data_collect_every_n_seconds);SEND_DATA_EVERY_N_MILLISECONDS_BACKUP=1000*Number(res.keystroke_data_collect_every_n_seconds);console.log('Keyguard Script: SEND_DATA_EVERY_N_MILLISECONDS Loaded to: -> '+String(SEND_DATA_EVERY_N_MILLISECONDS))}else{console.log('Keyguard Script: Problem with collect keystroke code limit');SEND_DATA_EVERY_N_MILLISECONDS=5000;SEND_DATA_EVERY_N_MILLISECONDS_BACKUP=5000;console.log(res)}
if(loggedInFlag){startTimerSendData(SEND_DATA_EVERY_N_MILLISECONDS)}},function(error){SEND_DATA_EVERY_N_MILLISECONDS=5000;SEND_DATA_EVERY_N_MILLISECONDS_BACKUP=5000;console.log('Keyguard Script: Error at get keystroke code collect limit');console.log(error)})}
function onKeyUpProcedure(e){if(loggedInFlag){logKeystrokeUpData(e)}else{if(e.target.classList.contains('keystroke-auth-box-user-feedback')){logKeystrokeUpData(e)}}}
function onKeyDownProcedure(e){if(loggedInFlag){logKeystrokeDownData(e)}else{if(e.target.classList.contains('keystroke-auth-box-user-feedback')){logKeystrokeDownData(e)}}}
function logKeystrokeDownData(e){if(!e.repeat){keystrokeData.push({event:'keystrokeDown',key:e.code,timestamp:Date.now()})}}
function logKeystrokeUpData(e){keystrokeData.push({event:'keystrokeUp',key:e.code,timestamp:Date.now()})}
function sendData(force=!1,byPassTest=!1){if(!force){if((keystrokeData.length<KEYSTROKE_DATA_LENGTH_LIMIT&&loggedInFlag)){return}}
let dataBody={track_code:track_code,subject:currentUser.username,keystrokeData:JSON.stringify(keystrokeData),byPassTest:byPassTest};resetKeystrokeData();Rx.DOM.post({url:cont_auth_server_collect_url,body:dataBody,headers:myheaders}).subscribe(function(data){res=JSON.parse(data.response);if(res.alert==!0&&loggedInFlag){if(res.isImpostor==!0){console.log('Keyguard Script Server: User is impostor!');if(!insideImpostorModalFlag){resetKeystrokeData();KEYSTROKE_DATA_LENGTH_LIMIT=50;activateImpostorModal()}else{deactivateImpostorModal();activateUserRejectedModal();setTimeout(function(){window.location.replace(window.location.origin+'/login')},4500)}}else{if(res.not_enough_training==!0){alert('Impostor Alert Failed: Not enough training to test the data!!!')}}}else{if(!insideImpostorModalFlag){}else{KEYSTROKE_DATA_LENGTH_LIMIT=KEYSTROKE_DATA_LENGTH_LIMIT_BACKUP;deactivateImpostorModal();insideImpostorModalFlag=!1;activateUserRetakeSuccessModal();if(keystrokeData.length>0){sendData(force=!0,byPassTest=!0)}}}},function(err){console.log('Error at ajax POST: ');console.log(err)})}
function findUsername(token_=''){console.log('Keyguard Script: findUsername Fired.');if(token_==''){try{let tmp_currentUser=JSON.parse(sessionStorage.getItem('currentUser'));token_=tmp_currentUser.token}catch(errorr){console.log('Keyguard Script: CurrentUser is null at sessionStorage.');return}}
try{let decode_tok=jwt_decode(token_);let tmp_username=decode_tok.username;if(tmp_username===undefined){console.log('Keyguard Script: No username in this jwt-token')}else{console.log('Keyguard Script: Username found -> '+tmp_username);currentUser.token=token_;currentUser.username=tmp_username;loggedInFlag=!0;if(keystrokeData.length>0){sendData(force=!0)}
if(SEND_DATA_EVERY_N_MILLISECONDS!=-1){startTimerSendData(SEND_DATA_EVERY_N_MILLISECONDS)}}}catch(errr){console.log('Keyguard Script: Invalid jwt-token');console.log(errr)}}
function activateImpostorModal(){insideImpostorModalFlag=!0;if(!document.getElementById('keyguardScriptImpostorModal')){$(document.body).append('\
        <div class="modal" id="keyguardScriptImpostorModal">\
          <div class="modal-dialog">\
            <div class="modal-content">\
              <div class="modal-header" style="text-align:center;">\
                 <i class="fa fa-hand-paper-o fa-4x" style="color:red;" aria-hidden="true"></i>\
                <h3 class="modal-title" style="font-weight:bold;">&nbsp;Keystroke Authentication Failed!</h3>\
              </div>\
              <div class="modal-body">\
                 <p style="text-align:center;margin-top:-10px;font-size:14px;">You are requested to <strong>type the text below</strong> , in order to continue browsing this website.</p>\
                <br>\
                <div class="retake-access-container" style="border-radius:7px;background-color:rgba(0, 0, 0,0.84);padding:25px 8px 30px 8px;">\
                  <div class="retake-p-input" style="text-align:center;">\
                     <p id="keyguardScriptretakeP" style="font-size:20px;color:white;"><img src="data:image/gif;base64,R0lGODlhEAAQAPIAAP///wAAAMLCwkJCQgAAAGJiYoKCgpKSkiH/C05FVFNDQVBFMi4wAwEAAAAh/hpDcmVhdGVkIHdpdGggYWpheGxvYWQuaW5mbwAh+QQJCgAAACwAAAAAEAAQAAADMwi63P4wyklrE2MIOggZnAdOmGYJRbExwroUmcG2LmDEwnHQLVsYOd2mBzkYDAdKa+dIAAAh+QQJCgAAACwAAAAAEAAQAAADNAi63P5OjCEgG4QMu7DmikRxQlFUYDEZIGBMRVsaqHwctXXf7WEYB4Ag1xjihkMZsiUkKhIAIfkECQoAAAAsAAAAABAAEAAAAzYIujIjK8pByJDMlFYvBoVjHA70GU7xSUJhmKtwHPAKzLO9HMaoKwJZ7Rf8AYPDDzKpZBqfvwQAIfkECQoAAAAsAAAAABAAEAAAAzMIumIlK8oyhpHsnFZfhYumCYUhDAQxRIdhHBGqRoKw0R8DYlJd8z0fMDgsGo/IpHI5TAAAIfkECQoAAAAsAAAAABAAEAAAAzIIunInK0rnZBTwGPNMgQwmdsNgXGJUlIWEuR5oWUIpz8pAEAMe6TwfwyYsGo/IpFKSAAAh+QQJCgAAACwAAAAAEAAQAAADMwi6IMKQORfjdOe82p4wGccc4CEuQradylesojEMBgsUc2G7sDX3lQGBMLAJibufbSlKAAAh+QQJCgAAACwAAAAAEAAQAAADMgi63P7wCRHZnFVdmgHu2nFwlWCI3WGc3TSWhUFGxTAUkGCbtgENBMJAEJsxgMLWzpEAACH5BAkKAAAALAAAAAAQABAAAAMyCLrc/jDKSatlQtScKdceCAjDII7HcQ4EMTCpyrCuUBjCYRgHVtqlAiB1YhiCnlsRkAAAOwAAAAAAAAAAAA=="></p>\
                  </div>\
                  <div class="retake-input" style="text-align:center;">\
                     <input id="keyguardScriptretakeInput" ondrop="return false" onpaste="return false" placeholder="start typing..." style="width:90%;color:black;font-size:20px;">\
                  </div>\
                </div>\
             </div>\
            </div>\
          </div>\
        </div>')
$("#keyguardScriptretakeInput").on("click",function(){$('#keyguardScriptretakeInput').css({"background-image":"url(\'http://loadinggif.com/images/image-selection/3.gif\')","background-size":"25px 25px","background-position":"right center","background-repeat":"no-repeat",})})}else{$('#keyguardScriptretakeP').html('<img src="data:image/gif;base64,R0lGODlhEAAQAPIAAP///wAAAMLCwkJCQgAAAGJiYoKCgpKSkiH/C05FVFNDQVBFMi4wAwEAAAAh/hpDcmVhdGVkIHdpdGggYWpheGxvYWQuaW5mbwAh+QQJCgAAACwAAAAAEAAQAAADMwi63P4wyklrE2MIOggZnAdOmGYJRbExwroUmcG2LmDEwnHQLVsYOd2mBzkYDAdKa+dIAAAh+QQJCgAAACwAAAAAEAAQAAADNAi63P5OjCEgG4QMu7DmikRxQlFUYDEZIGBMRVsaqHwctXXf7WEYB4Ag1xjihkMZsiUkKhIAIfkECQoAAAAsAAAAABAAEAAAAzYIujIjK8pByJDMlFYvBoVjHA70GU7xSUJhmKtwHPAKzLO9HMaoKwJZ7Rf8AYPDDzKpZBqfvwQAIfkECQoAAAAsAAAAABAAEAAAAzMIumIlK8oyhpHsnFZfhYumCYUhDAQxRIdhHBGqRoKw0R8DYlJd8z0fMDgsGo/IpHI5TAAAIfkECQoAAAAsAAAAABAAEAAAAzIIunInK0rnZBTwGPNMgQwmdsNgXGJUlIWEuR5oWUIpz8pAEAMe6TwfwyYsGo/IpFKSAAAh+QQJCgAAACwAAAAAEAAQAAADMwi6IMKQORfjdOe82p4wGccc4CEuQradylesojEMBgsUc2G7sDX3lQGBMLAJibufbSlKAAAh+QQJCgAAACwAAAAAEAAQAAADMgi63P7wCRHZnFVdmgHu2nFwlWCI3WGc3TSWhUFGxTAUkGCbtgENBMJAEJsxgMLWzpEAACH5BAkKAAAALAAAAAAQABAAAAMyCLrc/jDKSatlQtScKdceCAjDII7HcQ4EMTCpyrCuUBjCYRgHVtqlAiB1YhiCnlsRkAAAOwAAAAAAAAAAAA==">');$('#keyguardScriptretakeInput').css({"background-image":"","background-size":"","background-position":"","background-repeat":"",})}
$('#keyguardScriptretakeInput').val('');$("#ngx-app-container-wrapper").css("opacity","0");$('#keyguardScriptImpostorModal').modal({backdrop:'static',keyboard:!1})
var randomSentence='...';Rx.DOM.get({url:cont_auth_server_get_random_sentence+'/'+String(RANDOM_SENTENCE_RETAKE_MAXIMUM_LENGTH),headers:myheaders}).subscribe(function(data){res=JSON.parse(data.response);if(res.success==!0){randomSentence=res.sentence;$('#keyguardScriptretakeP').text(randomSentence)}},function(error){console.log(error);randomSentence='hello world'
$('#keyguardScriptretakeP').text(randomSentence)})}
function deactivateImpostorModal(){$('#keyguardScriptImpostorModal').modal('hide');$("#ngx-app-container-wrapper").css("opacity","1")}
function activateUserRejectedModal(){$(document.body).append('\
    <div class="modal" id="keyguardScriptUserRejectedModal">\
      <div class="modal-dialog">\
        <div class="modal-content">\
          <div class="modal-header" style="text-align:center;">\
            <i class="fa fa-ban fa-4x" style="color:red;" aria-hidden="true"></i>\
            <h2 class="modal-title" style="font-weight:bold;">&nbsp;You are rejected!</h2>\
            <p style="font-style:italic;">You will be redirected back to login page.</p>\
          </div>\
        </div>\
      </div>\
    </div>')
$("#ngx-app-container-wrapper").css("opacity","0");$('#keyguardScriptUserRejectedModal').modal({backdrop:'static',keyboard:!1})}
function deactivateUserRejectedModal(){$('#keyguardScriptUserRejectedModal').modal('hide');$("#ngx-app-container-wrapper").css("opacity","1")}
function activateUserRetakeSuccessModal(){if(!document.getElementById('keyguardScriptUserRetakeSuccessModal')){$(document.body).append('\
        <div class="modal" id="keyguardScriptUserRetakeSuccessModal">\
          <div class="modal-dialog">\
            <div class="modal-content">\
              <div class="modal-header" style="text-align:center;">\
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>\
                 <i class="fa fa-check-circle fa-4x" aria-hidden="true" style="color:green;"></i>\
                <h2 class="modal-title" style="font-weight:bold;">You passed the test!</h2>\
              <p style="font-style:italic;">You can continue browsing this website.</p>\
                <div align="right"><button type="button" class="btn btn-default"  data-dismiss="modal">Close</button></div>\
              </div>\
            </div>\
          </div>\
        </div>')}
$("#ngx-app-container-wrapper").css("opacity","1");$('#keyguardScriptUserRetakeSuccessModal').modal('show')}
function startTimerSendData(ms){if(sendDataInterval!=0){clearInterval(sendDataInterval);sendDataInterval=0}
console.log('KeyguardScript: Send data interval set every '+String(ms/1000)+' seconds');sendDataInterval=setInterval(sendData,ms)}
function clearTimerSendData(){if(sendDataInterval!=0){clearInterval(sendDataInterval);sendDataInterval=0}else{console.log('KeyguardScript on ClearTimerSendData(): Warning, clear Timer was called, when timer was already cleared.')}}
function resetKeystrokeData(){keystrokeData=[]}
function resetLogInStuff(){currentUser.token='';currentUser.username='';loggedInFlag=!1}

console.log('Keyguard Script: Init...');var allDOMS=document.getElementsByTagName('*');var keydownDOMObserver=Rx.DOM.keydown(allDOMS);var keyupDOMObserver=Rx.DOM.keyup(allDOMS);var keystrokeData=[];var myheaders={'Content-Type':'application/x-www-form-urlencoded'};let tmp=document.getElementById('contAuthServerScriptTag').src.split('/');var cont_auth_server_url=tmp[0]+'//'+tmp[2];var cont_auth_server_get_keystroke_code_limit=cont_auth_server_url+'/collect/'+'get_keystroke_code_collect_limit/'+track_code
var cont_auth_server_collect_url=cont_auth_server_url+'/collect/'+'keystrokes';var cont_auth_server_get_random_sentence=cont_auth_server_url+'/misc/'+'get-random-sentence';var RAT_RANDOM_SENTENCE_LOGIN_MAXIMUM_LENGTH=60;var RAT_LEVENSHTEIN_LIMIT=5;var currentUser={'username':'',};var loggedInFlag=!1;window.addEventListener('beforeunload',function(event){if(keystrokeData.length>0&&loggedInFlag){sendData(force=!0);console.log('Keyguard Script: onBeforeUnload -> Data Sent');event.preventDefault()}});function keyGuardLoginProcedureStart(username_){console.log('Keyguard Script: Login Detected');keyguardSetSubjectUsername(username_);keyguardPopLoginModal()}
function keyGuardLogoutProcedureStart(){console.log('Keyguard Script: Logout Detected');if(keystrokeData.length>0){sendData(force=!0)}
resetLogInStuff();resetKeystrokeData()}
var keystrokeDOWNSubscriber=keydownDOMObserver.subscribe(function(keyEvent){if(keyEvent.keyCode!==91&&keyEvent.keyCode!==92&&keyEvent.keyCode!==18&&keyEvent.keyCode!==17&&keyEvent.keyCode!==93&&keyEvent.keyCode!==9){onKeyDownProcedure(keyEvent)}},function(err){console.log('Error in keydown event: '+err)});var keystrokeUPSubscriber=keyupDOMObserver.subscribe(function(keyEvent){if(keyEvent.keyCode!==91&&keyEvent.keyCode!==92&&keyEvent.keyCode!==18&&keyEvent.keyCode!==17&&keyEvent.keyCode!==93&&keyEvent.keyCode!==9){onKeyUpProcedure(keyEvent)}},function(err){console.log('Error in keyup event: '+err)});function onKeyUpProcedure(e){if(e.target.id=='keyguardLoginModalContentMainDivInput'){logKeystrokeUpData(e)}}
function onKeyDownProcedure(e){if(e.target.id=='keyguardLoginModalContentMainDivInput'){logKeystrokeDownData(e)}}
function logKeystrokeDownData(e){if(!e.repeat){keystrokeData.push({event:'keystrokeDown',key:e.code,timestamp:Date.now()})}}
function logKeystrokeUpData(e){keystrokeData.push({event:'keystrokeUp',key:e.code,timestamp:Date.now()})}
function sendData(force=!1){if(!force){if((keystrokeData.length<KEYSTROKE_DATA_LENGTH_LIMIT&&loggedInFlag)){return}}
let dataBody={track_code:track_code,subject:currentUser.username,keystrokeData:JSON.stringify(keystrokeData)};resetKeystrokeData();Rx.DOM.post({url:cont_auth_server_collect_url,body:dataBody,headers:myheaders}).subscribe(function(data){res=JSON.parse(data.response)},function(err){console.log('Error at ajax POST: ');console.log(err)})}
function keyguardSetSubjectUsername(username_=''){loggedInFlag=!0;currentUser.username=username_;console.log('Keyguard Script: findUsername Fired. Username set to ->'+currentUser.username)}
function keyguardPopLoginModal(){console.log('Keyguard Script: Activating login modal...');$('body').css('opacity','0.15');if(document.getElementById('keyguardLoginModal')==null){$('keystrokedynamics').append('<div id="keyguardLoginModal"><div id="keyguardLoginModalContent"><h2 id="keyguardLoginModalContentheader">Keystroke Dynamics Authentication Layer</h2><hr/><p id="keyguardLoginModalContentSubheader">Please type the text below in order to continue</p><div id="keyguardLoginModalContentMainDiv"> <p id="keyguardLoginModalContentMainDivP"><img id="keyguardLoginModalContentMainDivPLoadingImg" src="'+cont_auth_server_url+'/public/loading.gif'+'" /></p> <input id = "keyguardLoginModalContentMainDivInput" type="text" placeholder="Type the text above here..." onpaste="return false;" ondrop="return false;"  /> <p id="keyguardLoginModalContentMainDivPError">Texts differ a lot! Please try again.</p> </div><div id="keyguardLoginModalFooter"><button id="keyguardLoginModalFooterButton">Submit</button></div></div></div>');$('keystrokedynamics #keyguardLoginModal').css({'display':'block','position':'fixed','z-index':'1020','padding-top':'100px','left':'0','top':'0','width':'100%','height':'100%','overflow':'auto','background-color':'rgb(0,0,0)','background-color':'rgba(0,0,0,0.4)'});$('keystrokedynamics #keyguardLoginModalContent').css({'background-color':'#fefefe','margin':'auto','padding':'20px','padding-top':'20px','padding-left':'20px','padding-right':'20px','padding-bottom':'10px','border':'1px solid #888','width':'38%'});$('keystrokedynamics #keyguardLoginModalContentheader').css({'text-align':'center'});$('keystrokedynamics #keyguardLoginModalContentSubheader').css({'text-align':'center'});$('keystrokedynamics #keyguardLoginModalContentMainDiv').css({'background-color':'#262626','padding-top':'10px','padding-bottom':'20px','padding-right':'15px','padding-left':'15px','border-radius':'4px'});$('keystrokedynamics #keyguardLoginModalContentMainDivPLoadingImg').css({'width':'30px','height':'auto','text-align':'center'});$('keystrokedynamics #keyguardLoginModalContentMainDivP').css({'color':'white','font-size':'19px','text-align':'center'});$('keystrokedynamics #keyguardLoginModalContentMainDivInput').css({'font-size':'18px','width':'98%','color':'black'});$('keystrokedynamics #keyguardLoginModalContentMainDivPError').css({'display':'none','font-size':'15px','color':'#ffd906','text-align':'center','margin-bottom':'0px'});$('keystrokedynamics #keyguardLoginModalFooter').css({'text-align':'center','margin-top':'15px'});$('keystrokedynamics #keyguardLoginModalFooterButton').css({'background-color':'#e7e7e7','border':'1px solid #242424','color':'black','padding-top':'8px','padding-bottom':'8px','padding-right':'12px','padding-left':'12px','font-size':'16px','cursor':'pointer','border-radius':'4px'});$('keystrokedynamics #keyguardLoginModalFooterButton').click(function(){if(levenshtein($('keystrokedynamics #keyguardLoginModalContentMainDivInput').val(),$('keystrokedynamics #keyguardLoginModalContentMainDivP').text())<=RAT_LEVENSHTEIN_LIMIT){$('keystrokedynamics #keyguardLoginModal').css('display','none');$('body').css('opacity','1');sendData(force=!0)}else{console.log('Levenshtein >5')
$('keystrokedynamics #keyguardLoginModalContentMainDivPError').css('display','block');setTimeout(function(){$('keystrokedynamics #keyguardLoginModalContentMainDivPError').css('display','none')},1800)}})}else{$('keystrokedynamics #keyguardLoginModal').css('display','block');$('keystrokedynamics #keyguardLoginModalContentMainDivP').text('');$('keystrokedynamics #keyguardLoginModalContentMainDivPLoadingImg').css('display','inline')}
$('keystrokedynamics #keyguardLoginModalContentMainDivInput').val('');loadRandomSentenceFromServer(RAT_RANDOM_SENTENCE_LOGIN_MAXIMUM_LENGTH,function(err,val){if(err){console.log('Keyguard Script: Error in loadRandomSentenceFromServer ->')
console.log(err)
$('keystrokedynamics #keyguardLoginModalContentMainDivP').text('Hello darkness my old friend')}else{$('keystrokedynamics #keyguardLoginModalContentMainDivPLoadingImg').css('display','none')
$('keystrokedynamics #keyguardLoginModalContentMainDivP').text(val)}})}
function loadRandomSentenceFromServer(maximumLength,callback){Rx.DOM.get({url:cont_auth_server_get_random_sentence+'/'+String(maximumLength),headers:myheaders}).subscribe(function(data){res=JSON.parse(data.response);if(res.success==!0){callback(!1,res.sentence)}else{callback(res)}},function(error){callback(error)})}
function resetKeystrokeData(){keystrokeData=[]}
function resetLogInStuff(){currentUser.username='';loggedInFlag=!1}
